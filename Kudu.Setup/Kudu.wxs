<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">

  <!-- Common definitions -->
  <?ifndef KuduProductVersion?>
  <?define KuduProductVersion = "0.6.0.0"?>
  <?endif?>
  <?ifndef KuduManufacturer?>
  <?define KuduManufacturer = "Outercurve Foundation"?>
  <?endif?>
  <?define ArtifactsDir = "..\artifacts\$(var.Configuration)"?>
  <?define KuduServiceDir = "$(var.ArtifactsDir)\KuduService"?>
  <?define KuduServiceBinDir = "$(var.KuduServiceDir)\bin"?>
  <?define KuduServiceBinScriptsDir = "$(var.KuduServiceBinDir)\scripts"?>
  <?define KuduServiceMsBuildDir = "$(var.KuduServiceDir)\msbuild\Microsoft\VisualStudio\v10.0"?>
  <?define KuduServiceMsBuildDir11 = "$(var.KuduServiceDir)\msbuild\Microsoft\VisualStudio\v11.0"?>
  
  <?if $(env.PROCESSOR_ARCHITECTURE) = 'AMD64' ?>
    <?define ReferenceAssembliesDir = "$(env.ProgramFiles(x86))\Reference Assemblies"?>
 <?else ?>
  <?define ReferenceAssembliesDir = "$(env.ProgramFiles)\Reference Assemblies"?>
 <?endif?>
  
  <Product Id="*"
           Name="Kudu.Setup"
           Language="1033"
           Version="$(var.KuduProductVersion)"
           Manufacturer="$(var.KuduManufacturer)"
           UpgradeCode="20454678-7e74-4e0e-8ab0-2e8f9f7e3c5f">

    <Package InstallerVersion="200"
             Compressed="yes"
             InstallScope="perMachine"
             Description="Kudu services" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of Kudu Service was detected in the machine, this installation will abort." Schedule="afterInstallInitialize" />

    <Media Id="1"
           Cabinet="KuduService.cab"
           CompressionLevel="high"
           EmbedCab="yes" />

    <!-- Prerequisite check -->
    <PropertyRef Id="NETFRAMEWORK40FULL" />
    <Condition Message="This application requires .NET Framework v4.0. Please install the .NET Framework v4.0 then run this installer again.">
      Installed OR NETFRAMEWORK40FULL
    </Condition>

    <Condition Message="You need administrator privilege to install this application.">
      Privileged
    </Condition>

    <!-- Directory structure -->
    <SetDirectory Id="WINDOWSDRIVE" Value="[WindowsVolume]" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="WINDOWSDRIVE">
        <Directory Id="KUDU_BASE_DIR" Name="KuduService">
          <Directory Id="KUDU_WWWROOT" Name="wwwroot">

            <Directory Id="KUDU_SERVICE_BIN" Name="Bin">
              <Directory Id="KUDU_SERVICE_BIN_SCRIPTS" Name="Scripts" />
            </Directory>

            <Directory Id="KUDU_SERVICE_MSBUILD" Name="msbuild">
              <Directory Id ="KUDU_SERVICE_MSBUILD_MS" Name="Microsoft">
                <Directory Id="KUDU_SERVICE_MSBUILD_MS_VS" Name="VisualStudio">
                  <Directory Id="KUDU_SERVICE_MSBUILD_MS_VS_10" Name="v10.0">

                    <Directory Id="KUDU_SERVICE_MSBUILD_MS_VS_10_WEB" Name="Web"/>
                    <Directory Id="KUDU_SERVICE_MSBUILD_MS_VS_10_WEBAPPS" Name="WebApplications"/>

                  </Directory>
                  <Directory Id="KUDU_SERVICE_MSBUILD_MS_VS_11" Name="v11.0">

                    <Directory Id="KUDU_SERVICE_MSBUILD_MS_VS_11_WEB" Name="Web">
                      <Directory Id="KUDU_SERVICE_MSBUILD_MS_VS_11_WEB_COLLECTFILES" Name="CollectFiles"/>
                      <Directory Id="KUDU_SERVICE_MSBUILD_MS_VS_11_WEB_TRANSFORM" Name="Transform"/>
                    </Directory>
                    <Directory Id="KUDU_SERVICE_MSBUILD_MS_VS_11_WEBAPPS" Name="WebApplications"/>

                  </Directory>
                </Directory>
              </Directory>
              <Directory Id="KUDU_SERVICE_REF_ASM" Name="ReferenceAssemblies">
                <Directory Id="KUDU_SERVICE_REF_ASM_v40" Name="v4.0" />
              </Directory>
            </Directory>

          </Directory>
        </Directory>
      </Directory>
    </Directory>

    <!-- Product files -->
    <DirectoryRef Id="KUDU_WWWROOT">

      <!-- Registry Key entry -->
      <Component Id="RegistryComponent" Guid="{3B4B2C90-2DDD-44E9-AC66-DFD45D0644C5}">
        <RegistryKey Root="HKLM" Key="SOFTWARE\Microsoft\Kudu" Action="createAndRemoveOnUninstall">
          <RegistryValue Name="Version" Value="$(var.KuduProductVersion)" Type="string" />
        </RegistryKey>
      </Component>

      <Component Id="Default.aspx" Guid="{DB6C3D9D-D0DD-42B6-A4C4-EA3D5F8428F4}">
        <File Id="Default.aspx" Source="$(var.KuduServiceDir)\Default.aspx" />
      </Component>
      
      <Component Id="Env.aspx" Guid="{352C64CB-76C2-49F1-B7BF-786EECA9CD4C}">
        <File Id="Env.aspx" Source="$(var.KuduServiceDir)\Env.aspx" />
      </Component>

      <Component Id="Web.config" Guid="{457A4FB5-F65C-4431-AB8A-A87F960ADDCC}">
        <File Id="Web.config" Source="$(var.KuduServiceDir)\Web.config" />
      </Component>

      <Component Id="commit" Guid="{DCC5FEC1-0431-492E-9960-DC43A91D6002}">
        <File Id="commit" Source="$(var.KuduServiceDir)\commit" />
      </Component>

    </DirectoryRef>

    <DirectoryRef Id="KUDU_SERVICE_BIN_SCRIPTS">

      <Component Id="selectNodeVersion.js" Guid="{A614DB70-81C5-43C0-BC74-3776408987D4}">
        <File Id="selectNodeVersion.js" Source="$(var.KuduServiceBinScriptsDir)\selectNodeVersion.js" />
      </Component>

      <Component Id="semver.js" Guid="{B54E4DAF-E614-4C3A-9583-97327362D1CB}">
        <File Id="semver.js" Source="$(var.KuduServiceBinScriptsDir)\semver.js" />
      </Component>

    </DirectoryRef>

    <DirectoryRef Id="KUDU_SERVICE_BIN">

      <Component Id="Kudu.Contracts.dll" Guid="{61A18C06-83A8-41CA-AA38-F9F665DE10C3}">
        <File Id="Kudu.Contracts.dll" Source="$(var.KuduServiceBinDir)\Kudu.Contracts.dll" />
      </Component>
      
      <Component Id="kudu.exe" Guid="{760F98D3-D22B-48BA-8C57-26FADBFBC845}">
        <File Id="kudu.exe" Source="$(var.KuduServiceBinDir)\kudu.exe" />
      </Component>
      
      <Component Id="Kudu.Core.dll" Guid="{B617864C-C336-46F9-B214-C583C4C8F30C}">
        <File Id="Kudu.Core.dll" Source="$(var.KuduServiceBinDir)\Kudu.Core.dll" />
      </Component>
      <Component Id="Kudu.Services.dll" Guid="{03D8B0B2-4FE2-4CCC-B54A-144430B05514}">
        <File Id="Kudu.Services.dll" Source="$(var.KuduServiceBinDir)\Kudu.Services.dll" />
      </Component>
      <Component Id="Kudu.Services.Web.dll" Guid="{4A3F4105-858A-4972-AE21-805C073F4CD9}">
        <File Id="Kudu.Services.Web.dll" Source="$(var.KuduServiceBinDir)\Kudu.Services.Web.dll" />
      </Component>
      
      <Component Id="Ionic.Zip.dll" Guid="{7BB6559B-39A6-4D67-A325-5DD73BECCCC7}">
        <File Id="Ionic.Zip.dll" Source="$(var.KuduServiceBinDir)\Ionic.Zip.dll" />
      </Component>

      <Component Id="Ninject.dll" Guid="{1337933F-2537-4C76-8FEF-FBADD5816448}">
        <File Id="Ninject.dll" Source="$(var.KuduServiceBinDir)\Ninject.dll" />
      </Component>
      
      <Component Id="Newtonsoft.Json.dll" Guid="{A60AA633-1F5F-4FE1-A93B-B891D63232A2}">
        <File Id="Newtonsoft.Json.dll" Source="$(var.KuduServiceBinDir)\Newtonsoft.Json.dll" />
      </Component>
      
      <Component Id="System.Net.Http.dll" Guid="{3D963AD3-1BA2-4508-AFAE-9635600B7D27}">
        <File Id="System.Net.Http.dll" Source="$(var.KuduServiceBinDir)\System.Net.Http.dll" />
      </Component> 
      
      <Component Id="Microsoft.Web.Infrastructure.dll" Guid="{96A2A444-20B6-48C6-867A-01A7E13AC927}">
        <File Id="Microsoft.Web.Infrastructure.dll" Source="$(var.KuduServiceBinDir)\Microsoft.Web.Infrastructure.dll" />
      </Component>
      
      <Component Id="System.IO.Abstractions.dll" Guid="{235869F1-F053-4FEE-8CD5-04E197A916ED}">
        <File Id="System.IO.Abstractions.dll" Source="$(var.KuduServiceBinDir)\System.IO.Abstractions.dll" />
      </Component>
      <Component Id="WebActivator.dll" Guid="{0C6F4200-3B48-4BB0-97E7-17543B5AECB3}">
        <File Id="WebActivator.dll" Source="$(var.KuduServiceBinDir)\WebActivator.dll" />
      </Component>
      
      <Component Id="XmlSettings.dll" Guid="{A0569F8D-226B-4361-A596-7B636DBB3581}">
        <File Id="XmlSettings.dll" Source="$(var.KuduServiceBinDir)\XmlSettings.dll" />
      </Component>
      
      <Component Id="System.Net.Http.Formatting.dll" Guid="{018623FB-6032-49BE-9AC1-08E4398FD98F}">
        <File Id="System.Net.Http.Formatting.dll" Source="$(var.KuduServiceBinDir)\System.Net.Http.Formatting.dll" />
      </Component>

      <Component Id="System.Net.Http.WebRequest.dll" Guid="{CD943BF7-8EE4-4BC7-BA66-79CD91EAEC57}">
        <File Id="System.Net.Http.WebRequest.dll" Source="$(var.KuduServiceBinDir)\System.Net.Http.WebRequest.dll" />
      </Component>

      <Component Id="System.Web.Http.dll" Guid="{8C405A12-9961-4167-BC11-70986B31A444}">
        <File Id="System.Web.Http.dll" Source="$(var.KuduServiceBinDir)\System.Web.Http.dll" />
      </Component>

      <Component Id="System.Web.Http.WebHost.dll" Guid="{1F9F48D0-39F9-48EB-B878-420E501D020F}">
        <File Id="System.Web.Http.WebHost.dll" Source="$(var.KuduServiceBinDir)\System.Web.Http.WebHost.dll" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="KUDU_SERVICE_MSBUILD_MS_VS_10_WEB">
      <Component Id="Microsoft.Web.Publishing.AllFilesInProjectFolder.targets" Guid="{0DE02D81-BAFE-4939-B903-D454B4D3603D}">
        <File Id="Microsoft.Web.Publishing.AllFilesInProjectFolder.targets" Source="$(var.KuduServiceMsBuildDir)\Web\Microsoft.Web.Publishing.AllFilesInProjectFolder.targets" />
      </Component>
      <Component Id="Microsoft.Web.Publishing.AllFilesInTheProject.targets" Guid="{9A35F0F7-6D04-4173-803E-040270478FB6}">
        <File Id="Microsoft.Web.Publishing.AllFilesInTheProject.targets" Source="$(var.KuduServiceMsBuildDir)\Web\Microsoft.Web.Publishing.AllFilesInTheProject.targets" />
      </Component>
      <Component Id="Microsoft.Web.Publishing.OnlyFilesToRunTheApp.targets" Guid="{BA70D756-5EF3-4B27-909A-8CB13E3F8413}">
        <File Id="Microsoft.Web.Publishing.OnlyFilesToRunTheApp.targets" Source="$(var.KuduServiceMsBuildDir)\Web\Microsoft.Web.Publishing.OnlyFilesToRunTheApp.targets" />
      </Component>
      <Component Id="Microsoft.Web.Publishing.targets" Guid="{4B06DD4C-5DF8-4B04-83D1-83CBBD16A818}">
        <File Id="Microsoft.Web.Publishing.targets" Source="$(var.KuduServiceMsBuildDir)\Web\Microsoft.Web.Publishing.targets" />
      </Component>
      <Component Id="Microsoft.Web.Publishing.Tasks.Dll" Guid="{CFE7A1D6-B7A9-4F97-8C2D-EB19C783E999}">
        <File Id="Microsoft.Web.Publishing.Tasks.Dll" Source="$(var.KuduServiceMsBuildDir)\Web\Microsoft.Web.Publishing.Tasks.Dll" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="KUDU_SERVICE_MSBUILD_MS_VS_10_WEBAPPS">
      <Component Id="Microsoft.WebApplication.Build.Tasks.Dll" Guid="{D9A90644-3F50-420E-9FC7-0EF987C2D29A}">
        <File Id="Microsoft.WebApplication.Build.Tasks.Dll" Source="$(var.KuduServiceMsBuildDir)\WebApplications\Microsoft.WebApplication.Build.Tasks.Dll" />
      </Component>
      <Component Id="Microsoft.WebApplication.targets" Guid="{555CAE90-180E-4345-AAAF-EF13C7DB4134}">
        <File Id="Microsoft.WebApplication.targets" Source="$(var.KuduServiceMsBuildDir)\WebApplications\Microsoft.WebApplication.targets" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="KUDU_SERVICE_MSBUILD_MS_VS_11_WEB">
      <Component Id="Microsoft.Web.Publishing.targets.v11" Guid="{2D5EADE2-1CAB-4B07-B9E5-5C79466475AC}">
        <File Id="Microsoft.Web.Publishing.targets.v11" Source="$(var.KuduServiceMsBuildDir11)\Web\Microsoft.Web.Publishing.targets" />
      </Component>
      <Component Id="Microsoft.Web.Publishing.Tasks.Dll.v11" Guid="{40B916DA-20D7-40DC-B369-AF49B34780E5}">
        <File Id="Microsoft.Web.Publishing.Tasks.Dll.v11" Source="$(var.KuduServiceMsBuildDir11)\Web\Microsoft.Web.Publishing.Tasks.Dll" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="KUDU_SERVICE_MSBUILD_MS_VS_11_WEB_COLLECTFILES">
      <Component Id="Microsoft.Web.Publishing.AllFilesInProjectFolder.targets.v11" Guid="{BE9D7EE5-D292-462A-A29A-FC2516BEE8AE}">
        <File Id="Microsoft.Web.Publishing.AllFilesInProjectFolder.targets.v11" Source="$(var.KuduServiceMsBuildDir11)\Web\CollectFiles\Microsoft.Web.Publishing.AllFilesInProjectFolder.targets" />
      </Component>
      <Component Id="Microsoft.Web.Publishing.AllFilesInTheProject.targets.v11" Guid="{D6109FB2-040D-4FF1-8418-B3D4199A56FF}">
        <File Id="Microsoft.Web.Publishing.AllFilesInTheProject.targets.v11" Source="$(var.KuduServiceMsBuildDir11)\Web\CollectFiles\Microsoft.Web.Publishing.AllFilesInTheProject.targets" />
      </Component>
      <Component Id="Microsoft.Web.Publishing.OnlyFilesToRunTheApp.targets.v11" Guid="{1C4F999E-0342-44C1-9A46-6C2A56E404DC}">
        <File Id="Microsoft.Web.Publishing.OnlyFilesToRunTheApp.targets.v11" Source="$(var.KuduServiceMsBuildDir11)\Web\CollectFiles\Microsoft.Web.Publishing.OnlyFilesToRunTheApp.targets" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="KUDU_SERVICE_MSBUILD_MS_VS_11_WEB_TRANSFORM">
      <Component Id="Microsoft.Web.Publishing.AspNetCompileMerge.targets.v11" Guid="{022E1290-E8DD-4110-95BA-9E7DFD7EF6C1}">
        <File Id="Microsoft.Web.Publishing.AspNetCompileMerge.targets.v11" Source="$(var.KuduServiceMsBuildDir11)\Web\Transform\Microsoft.Web.Publishing.AspNetCompileMerge.targets" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="KUDU_SERVICE_MSBUILD_MS_VS_11_WEBAPPS">
      <Component Id="Microsoft.WebApplication.Build.Tasks.Dll.v11" Guid="{7E288120-AE2E-47C0-86A3-96F02322144E}">
        <File Id="Microsoft.WebApplication.Build.Tasks.Dll.v11" Source="$(var.KuduServiceMsBuildDir11)\WebApplications\Microsoft.WebApplication.Build.Tasks.Dll" />
      </Component>
      <Component Id="Microsoft.WebApplication.targets.v11" Guid="{9640EA37-6A07-423B-85A4-A5BDB267BBE6}">
        <File Id="Microsoft.WebApplication.targets.v11" Source="$(var.KuduServiceMsBuildDir11)\WebApplications\Microsoft.WebApplication.targets" />
      </Component>
      <Component Id="Kudu.targets.v11" Guid="{04A18D17-6C3F-4281-B1B1-372BDF1AD2C6}">
        <File Source="$(var.KuduServiceMsBuildDir11)\WebApplications\Kudu.targets" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="KUDU_SERVICE_REF_ASM_v40">
      <Component Id="System.ComponentModel.DataAnnotations.dll.v40" Guid="{1CF53B6B-2137-4DD7-AE33-875B5BBEA794}">
        <File Source="$(var.ReferenceAssembliesDir)\Microsoft\Framework\.NETFramework\v4.0\System.ComponentModel.DataAnnotations.dll" />
      </Component>
    </DirectoryRef>

    <Feature Id="RequiredComponents" Level="1">
      <ComponentRef Id="RegistryComponent" />

      <ComponentRef Id="Default.aspx" />
      <ComponentRef Id="Env.aspx" />
      <ComponentRef Id="Web.config" />
      <ComponentRef Id="commit" />

      <ComponentRef Id="kudu.exe"/>
      <ComponentRef Id="Kudu.Contracts.dll"/>
      <ComponentRef Id="Kudu.Core.dll"/>
      <ComponentRef Id="Kudu.Services.dll"/>
      <ComponentRef Id="Kudu.Services.Web.dll"/>
      <ComponentRef Id="selectNodeVersion.js"/>
      <ComponentRef Id="semver.js"/>

      <ComponentRef Id="Ninject.dll" />

      <ComponentRef Id="Ionic.Zip.dll" />
      <ComponentRef Id="Newtonsoft.Json.dll" />

      <ComponentRef Id="Microsoft.Web.Infrastructure.dll" />
      <ComponentRef Id="System.IO.Abstractions.dll" />
      <ComponentRef Id="WebActivator.dll" />
      <ComponentRef Id="XmlSettings.dll" />
      
      <ComponentRef Id="System.Net.Http.dll" />
      <ComponentRef Id="System.Net.Http.Formatting.dll" />
      <ComponentRef Id="System.Net.Http.WebRequest.dll" />
      <ComponentRef Id="System.Web.Http.dll" />
      <ComponentRef Id="System.Web.Http.WebHost.dll" />

      <ComponentRef Id="Microsoft.Web.Publishing.AllFilesInProjectFolder.targets" />
      <ComponentRef Id="Microsoft.Web.Publishing.AllFilesInTheProject.targets" />
      <ComponentRef Id="Microsoft.Web.Publishing.OnlyFilesToRunTheApp.targets" />
      <ComponentRef Id="Microsoft.Web.Publishing.targets" />
      <ComponentRef Id="Microsoft.Web.Publishing.Tasks.Dll" />

      <ComponentRef Id="Microsoft.WebApplication.Build.Tasks.Dll" />
      <ComponentRef Id="Microsoft.WebApplication.targets" />
      <ComponentRef Id="Kudu.targets.v11" />

      <ComponentRef Id="Microsoft.Web.Publishing.AllFilesInProjectFolder.targets.v11" />
      <ComponentRef Id="Microsoft.Web.Publishing.AllFilesInTheProject.targets.v11" />
      <ComponentRef Id="Microsoft.Web.Publishing.OnlyFilesToRunTheApp.targets.v11" />
      <ComponentRef Id="Microsoft.Web.Publishing.AspNetCompileMerge.targets.v11" />
      <ComponentRef Id="Microsoft.Web.Publishing.targets.v11" />
      <ComponentRef Id="Microsoft.Web.Publishing.Tasks.Dll.v11" />

      <ComponentRef Id="Microsoft.WebApplication.Build.Tasks.Dll.v11" />
      <ComponentRef Id="Microsoft.WebApplication.targets.v11" />

      <ComponentRef Id="System.ComponentModel.DataAnnotations.dll.v40" />
    </Feature>

  </Product>
</Wix>